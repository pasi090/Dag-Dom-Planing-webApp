<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAG Garment Factory Planner</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

    <!-- jsPDF + AutoTable for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap');

        :root {
            --bg: #0f0f0f;
            --surface: #1a1a1a;
            --surface2: #222222;
            --surface3: #2a2a2a;
            --border: #333333;
            --border2: #444444;
            --accent: #f5a623;
            --accent2: #e8901a;
            --accent-dim: rgba(245,166,35,0.12);
            --green: #2ecc71;
            --green-dim: rgba(46,204,113,0.12);
            --red: #e74c3c;
            --red-dim: rgba(231,76,60,0.12);
            --blue: #3498db;
            --blue-dim: rgba(52,152,219,0.12);
            --text: #f0f0f0;
            --text2: #aaaaaa;
            --text3: #666666;
            --mono: 'IBM Plex Mono', monospace;
            --sans: 'IBM Plex Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--sans);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           LOGIN SCREEN
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #loginContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--bg);
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 39px, var(--border) 39px, var(--border) 40px),
                repeating-linear-gradient(90deg, transparent, transparent 39px, var(--border) 39px, var(--border) 40px);
        }

        .login-box {
            background: var(--surface);
            border: 1px solid var(--border2);
            padding: 50px 44px;
            width: 420px;
            position: relative;
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--accent);
        }

        .login-logo {
            font-family: var(--mono);
            font-size: 11px;
            letter-spacing: 4px;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .login-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .login-sub {
            font-size: 13px;
            color: var(--text2);
            margin-bottom: 36px;
        }

        .field-label {
            font-family: var(--mono);
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text3);
            margin-bottom: 8px;
            display: block;
        }

        .field-input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border2);
            color: var(--text);
            padding: 12px 14px;
            font-family: var(--mono);
            font-size: 14px;
            margin-bottom: 20px;
            transition: border-color 0.2s;
            outline: none;
        }

        .field-input:focus { border-color: var(--accent); }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            color: #000;
            font-family: var(--mono);
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .btn-primary:hover { background: var(--accent2); }
        .btn-primary:active { transform: scale(0.99); }

        .btn-outline {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border2);
            color: var(--text2);
            font-family: var(--mono);
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 10px;
            transition: border-color 0.2s, color 0.2s;
        }

        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

        #authMessage {
            font-family: var(--mono);
            font-size: 12px;
            margin-top: 14px;
            text-align: center;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           APP SHELL
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #appContent { display: none; min-height: 100vh; }

        .topbar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .topbar-icon {
            width: 32px;
            height: 32px;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .topbar-title {
            font-family: var(--mono);
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .topbar-user {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--text3);
        }

        .btn-logout {
            padding: 6px 16px;
            background: transparent;
            border: 1px solid var(--border2);
            color: var(--text2);
            font-family: var(--mono);
            font-size: 11px;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .btn-logout:hover { border-color: var(--red); color: var(--red); }

        /* ‚îÄ‚îÄ NAV TABS ‚îÄ‚îÄ */
        .nav-tabs {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            padding: 0 32px;
            gap: 2px;
        }

        .nav-tab {
            padding: 14px 22px;
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text3);
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
            margin-bottom: -1px;
        }

        .nav-tab:hover { color: var(--text2); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
        .main-content {
            padding: 32px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
        }

        .page-title {
            font-family: var(--mono);
            font-size: 11px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--text3);
            margin-bottom: 4px;
        }

        .page-heading {
            font-size: 24px;
            font-weight: 700;
        }

        /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 20px 22px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 2px;
        }

        .stat-card.amber::after { background: var(--accent); }
        .stat-card.green::after { background: var(--green); }
        .stat-card.blue::after { background: var(--blue); }
        .stat-card.red::after { background: var(--red); }

        .stat-label {
            font-family: var(--mono);
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text3);
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: var(--mono);
            font-size: 32px;
            font-weight: 700;
        }

        .stat-card.amber .stat-value { color: var(--accent); }
        .stat-card.green .stat-value { color: var(--green); }
        .stat-card.blue .stat-value { color: var(--blue); }
        .stat-card.red .stat-value { color: var(--red); }

        .stat-sub {
            font-size: 12px;
            color: var(--text3);
            margin-top: 4px;
        }

        /* ‚îÄ‚îÄ LINE CARDS ‚îÄ‚îÄ */
        .lines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 16px;
        }

        .line-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 22px;
            position: relative;
            transition: border-color 0.2s;
        }

        .line-card:hover { border-color: var(--border2); }

        .line-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .line-card-name {
            font-family: var(--mono);
            font-size: 15px;
            font-weight: 700;
        }

        .line-card-cap {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--text3);
            margin-top: 3px;
        }

        .badge {
            font-family: var(--mono);
            font-size: 9px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            padding: 4px 10px;
            border: 1px solid;
        }

        .badge-active { color: var(--green); border-color: var(--green); background: var(--green-dim); }
        .badge-idle { color: var(--text3); border-color: var(--border2); }
        .badge-warning { color: var(--accent); border-color: var(--accent); background: var(--accent-dim); }

        /* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
        .progress-wrap {
            margin: 14px 0;
        }

        .progress-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .progress-label {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--text2);
        }

        .progress-pct {
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 700;
            color: var(--accent);
        }

        .progress-bar {
            height: 4px;
            background: var(--surface3);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.6s ease;
        }

        .progress-fill.green { background: var(--green); }
        .progress-fill.red { background: var(--red); }

        /* ‚îÄ‚îÄ KV ROWS ‚îÄ‚îÄ */
        .kv-list { display: flex; flex-direction: column; gap: 8px; }

        .kv-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--surface2);
        }

        .kv-key {
            font-family: var(--mono);
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text3);
        }

        .kv-val {
            font-family: var(--mono);
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
        }

        .kv-val.accent { color: var(--accent); }
        .kv-val.green { color: var(--green); }
        .kv-val.red { color: var(--red); }

        /* ‚îÄ‚îÄ FEED DATE BOX ‚îÄ‚îÄ */
        .feed-box {
            margin-top: 14px;
            padding: 12px 16px;
            background: var(--accent-dim);
            border: 1px solid rgba(245,166,35,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .feed-label {
            font-family: var(--mono);
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--accent);
        }

        .feed-date {
            font-family: var(--mono);
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
        }

        /* ‚îÄ‚îÄ CHART SECTION ‚îÄ‚îÄ */
        .chart-section {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 28px;
        }

        .chart-title {
            font-family: var(--mono);
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text3);
            margin-bottom: 20px;
        }

        /* ‚îÄ‚îÄ FORM SECTIONS ‚îÄ‚îÄ */
        .form-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 28px;
            margin-bottom: 24px;
        }

        .form-card-title {
            font-family: var(--mono);
            font-size: 10px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 22px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        .form-field { display: flex; flex-direction: column; }

        .form-field label {
            font-family: var(--mono);
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text3);
            margin-bottom: 8px;
        }

        .form-field input,
        .form-field select {
            background: var(--surface2);
            border: 1px solid var(--border2);
            color: var(--text);
            padding: 11px 14px;
            font-family: var(--mono);
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-field input:focus,
        .form-field select:focus { border-color: var(--accent); }

        .form-field select option { background: var(--surface2); }

        .form-actions { margin-top: 20px; display: flex; gap: 12px; }

        .btn-submit {
            padding: 12px 28px;
            background: var(--accent);
            border: none;
            color: #000;
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-submit:hover { background: var(--accent2); }

        /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            font-family: var(--mono);
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text3);
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            background: var(--surface2);
        }

        .data-table td {
            padding: 12px 14px;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
            font-family: var(--mono);
            color: var(--text2);
        }

        .data-table tr:hover td { background: var(--surface2); }

        /* ‚îÄ‚îÄ ACTION BUTTONS (small) ‚îÄ‚îÄ */
        .btn-sm {
            padding: 5px 12px;
            font-family: var(--mono);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            border: 1px solid;
            background: transparent;
            text-transform: uppercase;
            transition: all 0.15s;
        }

        .btn-edit { color: var(--blue); border-color: var(--blue); }
        .btn-edit:hover { background: var(--blue-dim); }

        .btn-delete { color: var(--red); border-color: var(--red); }
        .btn-delete:hover { background: var(--red-dim); }

        /* ‚îÄ‚îÄ EXPORT BUTTONS ‚îÄ‚îÄ */
        .export-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn-export {
            padding: 9px 20px;
            background: transparent;
            border: 1px solid var(--border2);
            color: var(--text2);
            font-family: var(--mono);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-export:hover { border-color: var(--accent); color: var(--accent); }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open { display: flex; }

        .modal-box {
            background: var(--surface);
            border: 1px solid var(--border2);
            border-top: 2px solid var(--accent);
            padding: 36px;
            width: 500px;
            max-width: 95vw;
        }

        .modal-title {
            font-family: var(--mono);
            font-size: 11px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 22px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 22px;
        }

        /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text3);
            font-family: var(--mono);
        }

        .empty-state-icon { font-size: 40px; margin-bottom: 14px; opacity: 0.4; }
        .empty-state-text { font-size: 12px; letter-spacing: 1px; }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 900px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .form-grid { grid-template-columns: 1fr; }
            .lines-grid { grid-template-columns: 1fr; }
            .main-content { padding: 16px; }
            .topbar { padding: 0 16px; }
            .nav-tabs { padding: 0 16px; overflow-x: auto; }
        }

        @media (max-width: 500px) {
            .stats-row { grid-template-columns: 1fr 1fr; }
        }

        /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
        .search-wrap {
            margin-bottom: 16px;
            position: relative;
        }
        .search-input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border2);
            color: var(--text);
            padding: 10px 14px 10px 38px;
            font-family: var(--mono);
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--accent); }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text3);
            font-size: 14px;
            pointer-events: none;
        }
        .search-count {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--text3);
            margin-top: 8px;
            letter-spacing: 1px;
        }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 28px;
            right: 28px;
            background: var(--surface);
            border: 1px solid var(--border2);
            border-left: 3px solid var(--accent);
            padding: 14px 20px;
            font-family: var(--mono);
            font-size: 12px;
            z-index: 2000;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }

        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { border-left-color: var(--green); }
        .toast.error { border-left-color: var(--red); }

        /* ‚îÄ‚îÄ SECTION DIVIDER ‚îÄ‚îÄ */
        .section-divider {
            height: 1px;
            background: var(--border);
            margin: 28px 0;
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginContainer">
    <div class="login-box">
        <div class="login-logo">DAG Systems</div>
        <div class="login-title">Factory Planner</div>
        <div class="login-sub">Production Line Management</div>

        <label class="field-label">Email</label>
        <input type="email" class="field-input" id="loginEmail" placeholder="admin@factory.com">

        <label class="field-label">Password</label>
        <input type="password" class="field-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            onkeydown="if(event.key==='Enter') login()">

        <button class="btn-primary" onclick="login()" id="loginBtn">Sign In</button>
        <button class="btn-outline" onclick="signup()">Create Account</button>

        <div id="authMessage" style="margin-top:14px; font-family:var(--mono); font-size:12px; text-align:center; min-height:20px;"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="appContent">
    <div class="topbar">
        <div class="topbar-brand">
            <div class="topbar-icon">üè≠</div>
            <div>
                <div class="topbar-title">DAG FACTORY PLANNER</div>
            </div>
        </div>
        <div class="topbar-right">
            <span class="topbar-user" id="topbarUser"></span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard', this)">Dashboard</button>
        <button class="nav-tab" onclick="switchTab('lines', this)">Manage Lines</button>
        <button class="nav-tab" onclick="switchTab('styles', this)">Purchase Orders</button>
        <button class="nav-tab" onclick="switchTab('assign', this)">Assign PO</button>
    </div>

    <div class="main-content">

        <!-- ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ -->
        <div id="dashboard" class="tab-pane active">
            <div class="page-header">
                <div>
                    <div class="page-title">Overview</div>
                    <div class="page-heading">Production Dashboard</div>
                </div>
                <div class="export-row" style="margin-bottom:0">
                    <button class="btn-export" onclick="exportPDF()">‚¨á Export PDF</button>
                    <button class="btn-export" onclick="exportExcel()">‚¨á Export Excel</button>
                </div>
            </div>

            <div class="stats-row" id="statsRow"></div>

            <div class="chart-section">
                <div class="chart-title">Production Progress by Line</div>
                <canvas id="progressChart" height="90"></canvas>
            </div>

            <div class="search-wrap" style="margin-bottom:18px;">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="searchDash" placeholder="Search by line name or PO..." oninput="filterDashboard(this.value)">
                <div class="search-count" id="searchDashCount"></div>
            </div>
            <div class="page-title" style="margin-bottom:16px; letter-spacing:2px; font-family:var(--mono); font-size:9px; text-transform:uppercase; color:var(--text3);">Active Lines</div>
            <div class="lines-grid" id="dashboardLines"></div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ MANAGE LINES ‚îÄ‚îÄ‚îÄ -->
        <div id="lines" class="tab-pane">
            <div class="page-header">
                <div>
                    <div class="page-title">Configuration</div>
                    <div class="page-heading">Production Lines</div>
                </div>
            </div>

            <div class="form-card">
                <div class="form-card-title">Add New Line</div>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Line Name</label>
                        <input type="text" id="lineName" placeholder="e.g. Line 10">
                    </div>
                    <div class="form-field">
                        <label>Daily Capacity (pcs/day)</label>
                        <input type="number" id="lineCapacity" placeholder="e.g. 500">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn-submit" onclick="addLine()">Add Line</button>
                </div>
            </div>

            <div class="form-card">
                <div class="form-card-title">Existing Lines</div>
                <div class="search-wrap">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchLines" placeholder="Search lines..." oninput="filterLines(this.value)">
                    <div class="search-count" id="searchLinesCount"></div>
                </div>
                <div id="linesList">
                    <div class="empty-state"><div class="empty-state-icon">‚öôÔ∏è</div><div class="empty-state-text">No lines added yet</div></div>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ PURCHASE ORDERS ‚îÄ‚îÄ‚îÄ -->
        <div id="styles" class="tab-pane">
            <div class="page-header">
                <div>
                    <div class="page-title">Inventory</div>
                    <div class="page-heading">Purchase Orders</div>
                </div>
            </div>

            <div class="form-card">
                <div class="form-card-title">Add New Purchase Order</div>
                <div class="form-grid">
                    <div class="form-field">
                        <label>PO Number</label>
                        <input type="text" id="styleNumber" placeholder="e.g. PO-2024-001">
                    </div>
                    <div class="form-field">
                        <label>Style Description</label>
                        <input type="text" id="styleName" placeholder="e.g. Men's T-Shirt Blue">
                    </div>
                    <div class="form-field">
                        <label>Total Quantity (pcs)</label>
                        <input type="number" id="styleQuantity" placeholder="e.g. 5000">
                    </div>
                    <div class="form-field">
                        <label>Delivery Deadline</label>
                        <input type="date" id="styleDeadline">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn-submit" onclick="addStyle()">Add PO</button>
                </div>
            </div>

            <div class="form-card">
                <div class="form-card-title">All Purchase Orders</div>
                <div class="search-wrap">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchStyles" placeholder="Search by PO number or description..." oninput="filterStyles(this.value)">
                    <div class="search-count" id="searchStylesCount"></div>
                </div>
                <div id="stylesList">
                    <div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-text">No POs added yet</div></div>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ ASSIGN ‚îÄ‚îÄ‚îÄ -->
        <div id="assign" class="tab-pane">
            <div class="page-header">
                <div>
                    <div class="page-title">Scheduling</div>
                    <div class="page-heading">Assign PO to Line</div>
                </div>
            </div>

            <div class="form-card">
                <div class="form-card-title">New Assignment</div>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Production Line</label>
                        <select id="assignLine">
                            <option value="">Select a line...</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>Purchase Order</label>
                        <select id="assignStyle">
                            <option value="">Select a PO...</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>Start Date (auto-fills from line availability)</label>
                        <input type="date" id="assignStartDate">
                    </div>
                    <div class="form-field" id="calcPreview" style="display:none; justify-content:flex-end; align-items:flex-start; padding-top:20px;">
                        <div style="background:var(--surface2); border:1px solid var(--border); padding:14px 16px; width:100%;">
                            <div class="kv-key" style="margin-bottom:6px;">Estimated Days</div>
                            <div class="stat-value" id="previewDays" style="font-size:22px; color:var(--accent);">‚Äî</div>
                            <div class="stat-sub">working days (Mon‚ÄìSat)</div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn-submit" onclick="assignStyleToLine()">Assign PO</button>
                </div>
            </div>

            <div class="form-card">
                <div class="form-card-title">Assignment History</div>
                <div class="search-wrap">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchAssign" placeholder="Search by line or PO..." oninput="filterAssignments(this.value)">
                    <div class="search-count" id="searchAssignCount"></div>
                </div>
                <div id="assignmentsList">
                    <div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No assignments yet</div></div>
                </div>
            </div>
        </div>

    </div><!-- /main-content -->
</div><!-- /appContent -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     EDIT MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <div class="modal-title" id="editModalTitle">Edit</div>
        <div id="editModalBody"></div>
        <div class="modal-actions">
            <button class="btn-sm btn-delete" style="padding:8px 18px" onclick="closeModal()">Cancel</button>
            <button class="btn-submit" id="editModalSave" onclick="saveEdit()">Save Changes</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TOAST
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ============================================
// FIREBASE CONFIG
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyCPigkTIkKzmUtg9G0LoqcLOs15mEAopjI",
    authDomain: "dag-planner-new.firebaseapp.com",
    databaseURL: "https://dag-planner-new-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dag-planner-new",
    storageBucket: "dag-planner-new.firebasestorage.app",
    messagingSenderId: "592572288168",
    appId: "1:592572288168:web:9583b690abf749ec68c69d",
    measurementId: "G-X8VGNXSNCX"
};

let app, auth, database;
let currentUser = null;
let productionLines = [], styles = [], assignments = [];
let progressChart = null;
let editingType = null, editingId = null;

try {
    app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    database = firebase.database();
} catch(e) {
    console.error(e);
}

// ============================================
// WORKING DAYS CALCULATION (Mon‚ÄìSat, skip Sun)
// ============================================
function addWorkingDays(startDate, days) {
    const d = new Date(startDate);
    let added = 0;
    while (added < days) {
        d.setDate(d.getDate() + 1);
        if (d.getDay() !== 0) added++; // skip Sunday
    }
    return d;
}

function countWorkingDays(startDate, endDate) {
    const s = new Date(startDate);
    const e = new Date(endDate);
    let count = 0;
    const cur = new Date(s);
    while (cur <= e) {
        if (cur.getDay() !== 0) count++;
        cur.setDate(cur.getDate() + 1);
    }
    return count;
}

function workingDaysNeeded(quantity, capacity) {
    return Math.ceil(quantity / capacity);
}

function nextWorkingDay(date) {
    const d = new Date(date);
    d.setDate(d.getDate() + 1);
    while (d.getDay() === 0) d.setDate(d.getDate() + 1);
    return d;
}

function formatDate(dateStr) {
    if (!dateStr) return '‚Äî';
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
}

function toISODate(d) {
    return d.toISOString().split('T')[0];
}

// ============================================
// AUTH
// ============================================
function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!email || !password) { showAuthMsg('Please enter email and password', 'error'); return; }

    const btn = document.getElementById('loginBtn');
    btn.textContent = 'Signing in...';
    btn.disabled = true;

    if (!auth) { showAuthMsg('Firebase not initialized. Check console.', 'error'); btn.textContent = 'Sign In'; btn.disabled = false; return; }

    auth.signInWithEmailAndPassword(email, password)
        .then(uc => {
            currentUser = uc.user;
            showAuthMsg('Login successful!', 'success');
            showApp();
        })
        .catch(e => {
            showAuthMsg('‚ùå ' + e.message, 'error');
            btn.textContent = 'Sign In';
            btn.disabled = false;
        });
}

function signup() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!email || !password) { showAuthMsg('Please enter email and password', 'error'); return; }
    if (password.length < 6) { showAuthMsg('Password must be at least 6 characters', 'error'); return; }

    if (!auth) { showAuthMsg('Firebase not initialized. Check console.', 'error'); return; }

    auth.createUserWithEmailAndPassword(email, password)
        .then(uc => {
            currentUser = uc.user;
            showAuthMsg('Account created!', 'success');
            showApp();
        })
        .catch(e => showAuthMsg('‚ùå ' + e.message, 'error'));
}

function logout() {
    auth.signOut().then(() => { currentUser = null; hideApp(); });
}

function showAuthMsg(msg, type) {
    const el = document.getElementById('authMessage');
    el.textContent = msg;
    el.style.color = type === 'success' ? 'var(--green)' : 'var(--red)';
    el.style.marginTop = '12px';
}

function showApp() {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('appContent').style.display = 'block';
    if (currentUser) document.getElementById('topbarUser').textContent = currentUser.email;
    loadData();
}

function hideApp() {
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('appContent').style.display = 'none';
}

auth.onAuthStateChanged(user => {
    if (user) { currentUser = user; showApp(); }
    else hideApp();
});

// ============================================
// DATA
// ============================================
function loadData() {
    if (!currentUser) return;
    const ref = database.ref('users/' + currentUser.uid);

    ref.once('value').then(snap => {
        const data = snap.val();
        if (data) {
            productionLines = data.lines || [];
            styles = data.styles || [];
            assignments = data.assignments || [];
        } else {
            initSampleData();
        }
        updateUI();
    });

    ref.on('value', snap => {
        const data = snap.val();
        if (data) {
            productionLines = data.lines || [];
            styles = data.styles || [];
            assignments = data.assignments || [];
            updateUI();
        }
    });
}

function saveData() {
    if (!currentUser) return;
    database.ref('users/' + currentUser.uid).set({
        lines: productionLines,
        styles: styles,
        assignments: assignments
    }).catch(e => showToast('Save error: ' + e.message, 'error'));
}

function initSampleData() {
    for (let i = 1; i <= 9; i++) {
        productionLines.push({ id: `line-${i}`, name: `Line ${i}`, capacity: 500 + i * 50 });
    }
    saveData();
}

// ============================================
// TAB NAVIGATION
// ============================================
function switchTab(name, btn) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    if (btn) btn.classList.add('active');
    updateUI();
}

// ============================================
// ADD LINE
// ============================================
function addLine() {
    const name = document.getElementById('lineName').value.trim();
    const cap = parseInt(document.getElementById('lineCapacity').value);
    if (!name || !cap) { showToast('Fill in all fields', 'error'); return; }

    productionLines.push({ id: `line-${Date.now()}`, name, capacity: cap });
    document.getElementById('lineName').value = '';
    document.getElementById('lineCapacity').value = '';
    saveData();
    showToast('Line added successfully', 'success');
    updateUI();
}

// ============================================
// ADD STYLE / PO
// ============================================
function addStyle() {
    const number = document.getElementById('styleNumber').value.trim();
    const name = document.getElementById('styleName').value.trim();
    const qty = parseInt(document.getElementById('styleQuantity').value);
    const deadline = document.getElementById('styleDeadline').value;
    if (!number || !name || !qty || !deadline) { showToast('Fill in all fields', 'error'); return; }

    styles.push({ id: `style-${Date.now()}`, number, name, quantity: qty, deadline });
    document.getElementById('styleNumber').value = '';
    document.getElementById('styleName').value = '';
    document.getElementById('styleQuantity').value = '';
    document.getElementById('styleDeadline').value = '';
    saveData();
    showToast('PO added successfully', 'success');
    updateUI();
}

// ============================================
// ASSIGN PO ‚Üí LINE
// ============================================
function assignStyleToLine() {
    const lineId = document.getElementById('assignLine').value;
    const styleId = document.getElementById('assignStyle').value;
    const startDate = document.getElementById('assignStartDate').value;
    if (!lineId || !styleId || !startDate) { showToast('Fill in all fields', 'error'); return; }

    const line = productionLines.find(l => l.id === lineId);
    const style = styles.find(s => s.id === styleId);
    const days = workingDaysNeeded(style.quantity, line.capacity);
    const endDateObj = addWorkingDays(startDate, days);
    const endDate = toISODate(endDateObj);

    assignments.push({
        id: `assign-${Date.now()}`,
        lineId, styleId, startDate, endDate,
        daysNeeded: days
    });

    document.getElementById('assignStartDate').value = '';
    document.getElementById('calcPreview').style.display = 'none';
    saveData();
    showToast(`Assigned! ${days} working days ‚Üí completes ${formatDate(endDate)}`, 'success');
    switchTab('dashboard', document.querySelector('.nav-tab'));
    updateUI();
}

// ============================================
// NEXT FEEDING DATE (2 working days before end)
// ============================================
function getNextFeedingDate(lineId) {
    const lineAssignments = assignments
        .filter(a => a.lineId === lineId)
        .sort((a, b) => new Date(b.endDate) - new Date(a.endDate));

    if (lineAssignments.length === 0) return toISODate(new Date());

    // Go back 2 working days from the last end date
    const lastEnd = new Date(lineAssignments[0].endDate);
    let countdown = 2;
    const d = new Date(lastEnd);
    while (countdown > 0) {
        d.setDate(d.getDate() - 1);
        if (d.getDay() !== 0) countdown--;
    }

    const today = new Date();
    today.setHours(0,0,0,0);
    return d < today ? toISODate(today) : toISODate(d);
}

// ============================================
// PRODUCTION PROGRESS
// ============================================
function getProductionProgress(assignment) {
    const today = new Date(); today.setHours(0,0,0,0);
    const start = new Date(assignment.startDate);
    const end = new Date(assignment.endDate);

    if (today < start) return 0;
    if (today >= end) return 100;

    const totalDays = countWorkingDays(assignment.startDate, assignment.endDate);
    const doneDays = countWorkingDays(assignment.startDate, toISODate(today));
    return Math.min(100, Math.round((doneDays / totalDays) * 100));
}

// ============================================
// CURRENT / UPCOMING / OVERDUE ASSIGNMENT
// ============================================
function getLineCurrentAssignment(lineId) {
    const today = new Date(); today.setHours(0,0,0,0);
    return assignments.find(a => {
        if (a.lineId !== lineId) return false;
        const s = new Date(a.startDate); s.setHours(0,0,0,0);
        const e = new Date(a.endDate); e.setHours(0,0,0,0);
        return today >= s && today <= e;
    }) || null;
}

function getLineLastAssignment(lineId) {
    const la = assignments.filter(a => a.lineId === lineId).sort((a,b)=>new Date(b.endDate)-new Date(a.endDate));
    return la[0] || null;
}

// ============================================
// UPDATE ALL UI
// ============================================
function updateUI() {
    updateStats();
    updateDashboardLines();
    updateChart();
    updateLinesList();
    updateStylesList();
    updateAssignDropdowns();
    updateAssignmentsList();
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function updateStats() {
    const today = new Date(); today.setHours(0,0,0,0);
    const activeLines = productionLines.filter(l => getLineCurrentAssignment(l.id));
    const overdue = assignments.filter(a => {
        const e = new Date(a.endDate); e.setHours(0,0,0,0);
        return e < today;
    });

    document.getElementById('statsRow').innerHTML = `
        <div class="stat-card amber">
            <div class="stat-label">Total Lines</div>
            <div class="stat-value">${productionLines.length}</div>
            <div class="stat-sub">configured</div>
        </div>
        <div class="stat-card green">
            <div class="stat-label">Active Lines</div>
            <div class="stat-value">${activeLines.length}</div>
            <div class="stat-sub">in production today</div>
        </div>
        <div class="stat-card blue">
            <div class="stat-label">Total POs</div>
            <div class="stat-value">${styles.length}</div>
            <div class="stat-sub">purchase orders</div>
        </div>
        <div class="stat-card red">
            <div class="stat-label">Overdue</div>
            <div class="stat-value">${overdue.length}</div>
            <div class="stat-sub">past end date</div>
        </div>
    `;
}

// ‚îÄ‚îÄ DASHBOARD LINE CARDS ‚îÄ‚îÄ
function updateDashboardLines() {
    const container = document.getElementById('dashboardLines');
    if (!productionLines.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üè≠</div><div class="empty-state-text">No lines configured yet</div></div>`;
        return;
    }

    const today = new Date(); today.setHours(0,0,0,0);

    container.innerHTML = productionLines.map(line => {
        const cur = getLineCurrentAssignment(line.id);
        const feedDate = getNextFeedingDate(line.id);
        let cardHTML = '';

        if (cur) {
            const style = styles.find(s => s.id === cur.styleId);
            const pct = getProductionProgress(cur);
            const endD = new Date(cur.endDate); endD.setHours(0,0,0,0);
            const isLate = endD < today;
            const fillClass = isLate ? 'red' : (pct >= 75 ? 'green' : '');

            cardHTML = `
                <div class="line-card-header">
                    <div>
                        <div class="line-card-name">${line.name}</div>
                        <div class="line-card-cap">${line.capacity.toLocaleString()} pcs/day</div>
                    </div>
                    <span class="badge ${isLate ? 'badge-warning' : 'badge-active'}">${isLate ? 'Overdue' : 'Active'}</span>
                </div>
                <div class="progress-wrap">
                    <div class="progress-head">
                        <span class="progress-label">${style ? style.number : '‚Äî'} ¬∑ ${style ? style.name : ''}</span>
                        <span class="progress-pct">${pct}%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill ${fillClass}" style="width:${pct}%"></div></div>
                </div>
                <div class="kv-list">
                    <div class="kv-row">
                        <span class="kv-key">Quantity</span>
                        <span class="kv-val">${style ? style.quantity.toLocaleString() : '‚Äî'} pcs</span>
                    </div>
                    <div class="kv-row">
                        <span class="kv-key">Working Days</span>
                        <span class="kv-val">${cur.daysNeeded} days</span>
                    </div>
                    <div class="kv-row">
                        <span class="kv-key">Start</span>
                        <span class="kv-val">${formatDate(cur.startDate)}</span>
                    </div>
                    <div class="kv-row">
                        <span class="kv-key">Completion</span>
                        <span class="kv-val ${isLate ? 'red' : 'accent'}">${formatDate(cur.endDate)}</span>
                    </div>
                </div>
            `;
        } else {
            cardHTML = `
                <div class="line-card-header">
                    <div>
                        <div class="line-card-name">${line.name}</div>
                        <div class="line-card-cap">${line.capacity.toLocaleString()} pcs/day</div>
                    </div>
                    <span class="badge badge-idle">Idle</span>
                </div>
                <div style="padding: 24px 0; text-align:center; color: var(--text3); font-family: var(--mono); font-size:12px;">
                    No active assignment
                </div>
            `;
        }

        cardHTML += `
            <div class="feed-box">
                <span class="feed-label">üìÖ Next Feed Date</span>
                <span class="feed-date">${formatDate(feedDate)}</span>
            </div>
        `;

        return `<div class="line-card">${cardHTML}</div>`;
    }).join('');
}

// ‚îÄ‚îÄ CHART ‚îÄ‚îÄ
function updateChart() {
    const canvas = document.getElementById('progressChart');
    if (!canvas) return;

    const labels = productionLines.map(l => l.name);
    const data = productionLines.map(l => {
        const cur = getLineCurrentAssignment(l.id);
        return cur ? getProductionProgress(cur) : 0;
    });

    const colors = data.map(v => v >= 75 ? '#2ecc71' : v > 0 ? '#f5a623' : '#333333');

    if (progressChart) progressChart.destroy();

    progressChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Progress %',
                data,
                backgroundColor: colors,
                borderRadius: 2,
                barThickness: 28,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1a1a1a',
                    borderColor: '#444',
                    borderWidth: 1,
                    titleColor: '#aaa',
                    bodyColor: '#f0f0f0',
                    callbacks: {
                        label: ctx => ` ${ctx.parsed.y}% complete`
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: '#222', drawBorder: false },
                    ticks: { color: '#888', font: { family: 'IBM Plex Mono', size: 11 } }
                },
                y: {
                    min: 0, max: 100,
                    grid: { color: '#222', drawBorder: false },
                    ticks: {
                        color: '#888',
                        font: { family: 'IBM Plex Mono', size: 11 },
                        callback: v => v + '%'
                    }
                }
            }
        }
    });
}

// ‚îÄ‚îÄ LINES LIST (Manage Lines tab) ‚îÄ‚îÄ
function updateLinesList() {
    const container = document.getElementById('linesList');
    if (!productionLines.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚öôÔ∏è</div><div class="empty-state-text">No lines added yet</div></div>`;
        return;
    }

    container.innerHTML = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Line Name</th>
                    <th>Capacity (pcs/day)</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${productionLines.map(line => {
                    const cur = getLineCurrentAssignment(line.id);
                    return `
                        <tr>
                            <td style="color:var(--text); font-weight:600">${line.name}</td>
                            <td>${line.capacity.toLocaleString()}</td>
                            <td><span class="badge ${cur ? 'badge-active' : 'badge-idle'}">${cur ? 'Active' : 'Idle'}</span></td>
                            <td>
                                <button class="btn-sm btn-edit" onclick="editLine('${line.id}')">Edit</button>
                                &nbsp;
                                <button class="btn-sm btn-delete" onclick="deleteLine('${line.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

// ‚îÄ‚îÄ STYLES LIST (PO tab) ‚îÄ‚îÄ
function updateStylesList() {
    const container = document.getElementById('stylesList');
    if (!styles.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-text">No POs added yet</div></div>`;
        return;
    }

    const today = new Date(); today.setHours(0,0,0,0);

    container.innerHTML = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>PO Number</th>
                    <th>Description</th>
                    <th>Quantity</th>
                    <th>Deadline</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${styles.map(s => {
                    const dl = new Date(s.deadline); dl.setHours(0,0,0,0);
                    const late = dl < today;
                    return `
                        <tr>
                            <td style="color:var(--accent); font-weight:600">${s.number}</td>
                            <td style="color:var(--text)">${s.name}</td>
                            <td>${s.quantity.toLocaleString()}</td>
                            <td class="kv-val ${late ? 'red' : ''}">${formatDate(s.deadline)}</td>
                            <td>
                                <button class="btn-sm btn-edit" onclick="editStyle('${s.id}')">Edit</button>
                                &nbsp;
                                <button class="btn-sm btn-delete" onclick="deleteStyle('${s.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

// ‚îÄ‚îÄ ASSIGN DROPDOWNS ‚îÄ‚îÄ
function updateAssignDropdowns() {
    const lineSelect = document.getElementById('assignLine');
    const styleSelect = document.getElementById('assignStyle');

    const prevLine = lineSelect.value;
    const prevStyle = styleSelect.value;

    lineSelect.innerHTML = '<option value="">Select a line...</option>' +
        productionLines.map(l => `<option value="${l.id}">${l.name} ¬∑ ${l.capacity.toLocaleString()} pcs/day</option>`).join('');

    styleSelect.innerHTML = '<option value="">Select a PO...</option>' +
        styles.map(s => `<option value="${s.id}">${s.number} ‚Äî ${s.name} (${s.quantity.toLocaleString()})</option>`).join('');

    if (prevLine) lineSelect.value = prevLine;
    if (prevStyle) styleSelect.value = prevStyle;

}
    updatePreview();


function updatePreview() {
    const lineId = document.getElementById('assignLine').value;
    const styleId = document.getElementById('assignStyle').value;
    const preview = document.getElementById('calcPreview');

    if (lineId && styleId) {
        const line = productionLines.find(l => l.id === lineId);
        const style = styles.find(s => s.id === styleId);
        const days = workingDaysNeeded(style.quantity, line.capacity);
        document.getElementById('previewDays').textContent = days;
        preview.style.display = 'flex';
    } else {
        preview.style.display = 'none';
    }
}

// ‚îÄ‚îÄ ASSIGNMENT LIST ‚îÄ‚îÄ
function updateAssignmentsList() {
    const container = document.getElementById('assignmentsList');
    if (!assignments.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No assignments yet</div></div>`;
        return;
    }

    const sorted = [...assignments].sort((a,b) => new Date(b.startDate) - new Date(a.startDate));

    container.innerHTML = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Line</th>
                    <th>PO</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Working Days</th>
                    <th>Progress</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${sorted.map(a => {
                    const line = productionLines.find(l => l.id === a.lineId);
                    const style = styles.find(s => s.id === a.styleId);
                    const pct = getProductionProgress(a);
                    return `
                        <tr>
                            <td style="color:var(--text);font-weight:600">${line ? line.name : '?'}</td>
                            <td style="color:var(--accent)">${style ? style.number : '?'}</td>
                            <td>${formatDate(a.startDate)}</td>
                            <td>${formatDate(a.endDate)}</td>
                            <td>${a.daysNeeded}</td>
                            <td>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <div class="progress-bar" style="width:80px; display:inline-block">
                                        <div class="progress-fill ${pct>=75?'green':''}" style="width:${pct}%"></div>
                                    </div>
                                    <span style="font-family:var(--mono);font-size:11px;color:var(--text2)">${pct}%</span>
                                </div>
                            </td>
                            <td>
                                <button class="btn-sm btn-edit" onclick="editAssignment('${a.id}')">Edit</button>
&nbsp;
<button class="btn-sm btn-delete" onclick="deleteAssignment('${a.id}')">Remove</button>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

// ============================================
// EDIT / DELETE
// ============================================
function editLine(id) {
    const line = productionLines.find(l => l.id === id);
    if (!line) return;
    editingType = 'line';
    editingId = id;
    document.getElementById('editModalTitle').textContent = 'Edit Production Line';
    document.getElementById('editModalBody').innerHTML = `
        <div class="form-field" style="margin-bottom:16px">
            <label>Line Name</label>
            <input type="text" class="field-input" id="editField1" value="${line.name}">
        </div>
        <div class="form-field">
            <label>Daily Capacity (pcs/day)</label>
            <input type="number" class="field-input" id="editField2" value="${line.capacity}">
        </div>
    `;
    document.getElementById('editModal').classList.add('open');
}

function editStyle(id) {
    const s = styles.find(x => x.id === id);
    if (!s) return;
    editingType = 'style';
    editingId = id;
    document.getElementById('editModalTitle').textContent = 'Edit Purchase Order';
    document.getElementById('editModalBody').innerHTML = `
        <div class="form-grid">
            <div class="form-field">
                <label>PO Number</label>
                <input type="text" class="field-input" id="editField1" value="${s.number}">
            </div>
            <div class="form-field">
                <label>Description</label>
                <input type="text" class="field-input" id="editField2" value="${s.name}">
            </div>
            <div class="form-field">
                <label>Quantity</label>
                <input type="number" class="field-input" id="editField3" value="${s.quantity}">
            </div>
            <div class="form-field">
                <label>Deadline</label>
                <input type="date" class="field-input" id="editField4" value="${s.deadline}">
            </div>
        </div>
    `;
    document.getElementById('editModal').classList.add('open');
}

function saveEdit() {
    if (editingType === 'line') {
        const idx = productionLines.findIndex(l => l.id === editingId);
        if (idx < 0) return;
        productionLines[idx].name = document.getElementById('editField1').value.trim();
        productionLines[idx].capacity = parseInt(document.getElementById('editField2').value);
        showToast('Line updated', 'success');
    } else if (editingType === 'style') {
        const idx = styles.findIndex(s => s.id === editingId);
        if (idx < 0) return;
        styles[idx].number = document.getElementById('editField1').value.trim();
        styles[idx].name = document.getElementById('editField2').value.trim();
        styles[idx].quantity = parseInt(document.getElementById('editField3').value);
        styles[idx].deadline = document.getElementById('editField4').value;
        showToast('PO updated', 'success');
    }
    closeModal();
    saveData();
    updateUI();
}

function closeModal() {
    document.getElementById('editModal').classList.remove('open');
    editingType = null; editingId = null;
}
    function editAssignment(id) {
    const a = assignments.find(x => x.id === id);
    if (!a) return;
    editingType = 'assignment';
    editingId = id;
    document.getElementById('editModalTitle').textContent = 'Edit Assignment';
    document.getElementById('editModalBody').innerHTML = `
        <div class="form-grid">
            <div class="form-field">
                <label>Production Line</label>
                <select class="field-input" id="editField1">
                    ${productionLines.map(l => `<option value="${l.id}" ${l.id === a.lineId ? 'selected' : ''}>${l.name}</option>`).join('')}
                </select>
            </div>
            <div class="form-field">
                <label>Purchase Order</label>
                <select class="field-input" id="editField2">
                    ${styles.map(s => `<option value="${s.id}" ${s.id === a.styleId ? 'selected' : ''}>${s.number} ‚Äî ${s.name}</option>`).join('')}
                </select>
            </div>
            <div class="form-field">
                <label>Start Date</label>
                <input type="date" class="field-input" id="editField3" value="${a.startDate}">
            </div>
        </div>
    `;
    document.getElementById('editModal').classList.add('open');
}

function deleteLine(id) {
    if (!confirm('Delete this production line? This will also remove its assignments.')) return;
    productionLines = productionLines.filter(l => l.id !== id);
    assignments = assignments.filter(a => a.lineId !== id);
    saveData();
    showToast('Line deleted', 'success');
    updateUI();
}

function deleteStyle(id) {
    if (!confirm('Delete this PO? This will also remove its assignments.')) return;
    styles = styles.filter(s => s.id !== id);
    assignments = assignments.filter(a => a.styleId !== id);
    saveData();
    showToast('PO deleted', 'success');
    updateUI();
}

function deleteAssignment(id) {
    if (!confirm('Remove this assignment?')) return;
    assignments = assignments.filter(a => a.id !== id);
    saveData();
    showToast('Assignment removed', 'success');
    updateUI();
}

// ============================================
// EXPORT
// ============================================
function exportExcel() {
    const today = new Date(); today.setHours(0,0,0,0);

    // Sheet 1: Lines
    const linesData = productionLines.map(l => {
        const cur = getLineCurrentAssignment(l.id);
        const style = cur ? styles.find(s => s.id === cur.styleId) : null;
        const feed = getNextFeedingDate(l.id);
        return {
            'Line Name': l.name,
            'Capacity (pcs/day)': l.capacity,
            'Status': cur ? 'Active' : 'Idle',
            'Current PO': style ? style.number : '‚Äî',
            'Current Style': style ? style.name : '‚Äî',
            'Completion Date': cur ? cur.endDate : '‚Äî',
            'Progress %': cur ? getProductionProgress(cur) + '%' : '0%',
            'Next Feed Date': feed
        };
    });

    // Sheet 2: POs
    const posData = styles.map(s => ({
        'PO Number': s.number,
        'Description': s.name,
        'Quantity': s.quantity,
        'Deadline': s.deadline,
    }));

    // Sheet 3: Assignments
    const assignData = assignments.map(a => {
        const line = productionLines.find(l => l.id === a.lineId);
        const style = styles.find(s => s.id === a.styleId);
        return {
            'Line': line ? line.name : '‚Äî',
            'PO Number': style ? style.number : '‚Äî',
            'PO Description': style ? style.name : '‚Äî',
            'Start Date': a.startDate,
            'End Date': a.endDate,
            'Working Days': a.daysNeeded,
            'Progress %': getProductionProgress(a) + '%'
        };
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(linesData), 'Lines Overview');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(posData), 'Purchase Orders');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(assignData), 'Assignments');

    XLSX.writeFile(wb, `DAG_FactoryPlan_${toISODate(new Date())}.xlsx`);
    showToast('Excel exported successfully', 'success');
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    const today = toISODate(new Date());

    // Header
    doc.setFillColor(245, 166, 35);
    doc.rect(0, 0, doc.internal.pageSize.width, 18, 'F');
    doc.setTextColor(0,0,0);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(13);
    doc.text('DAG GARMENT FACTORY ‚Äî PRODUCTION PLAN', 14, 12);
    doc.setFontSize(9);
    doc.text(`Generated: ${today}`, doc.internal.pageSize.width - 14, 12, { align: 'right' });

    // Lines table
    doc.setTextColor(0,0,0);
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('PRODUCTION LINES OVERVIEW', 14, 28);

    const linesRows = productionLines.map(l => {
        const cur = getLineCurrentAssignment(l.id);
        const style = cur ? styles.find(s => s.id === cur.styleId) : null;
        const feed = getNextFeedingDate(l.id);
        return [
            l.name,
            l.capacity.toLocaleString(),
            cur ? 'Active' : 'Idle',
            style ? style.number : '‚Äî',
            style ? style.name : '‚Äî',
            cur ? cur.endDate : '‚Äî',
            cur ? getProductionProgress(cur) + '%' : '0%',
            feed
        ];
    });

    doc.autoTable({
        startY: 32,
        head: [['Line','Capacity','Status','PO No.','Style','Completion','Progress','Next Feed']],
        body: linesRows,
        theme: 'grid',
        headStyles: { fillColor: [30,30,30], textColor: [245,166,35], fontSize: 8, fontStyle: 'bold' },
        bodyStyles: { fontSize: 8, textColor: [40,40,40] },
        alternateRowStyles: { fillColor: [245,245,245] },
        styles: { font: 'helvetica' }
    });

    // Assignments on new page
    doc.addPage();
    doc.setFillColor(245, 166, 35);
    doc.rect(0, 0, doc.internal.pageSize.width, 18, 'F');
    doc.setTextColor(0,0,0);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(13);
    doc.text('DAG GARMENT FACTORY ‚Äî ASSIGNMENTS', 14, 12);
    doc.setFontSize(9);
    doc.text(`Generated: ${today}`, doc.internal.pageSize.width - 14, 12, { align: 'right' });

    doc.setFontSize(10);
    doc.text('ASSIGNMENT HISTORY', 14, 28);

    const assignRows = assignments.map(a => {
        const line = productionLines.find(l => l.id === a.lineId);
        const style = styles.find(s => s.id === a.styleId);
        return [
            line ? line.name : '‚Äî',
            style ? style.number : '‚Äî',
            style ? style.name : '‚Äî',
            a.startDate,
            a.endDate,
            a.daysNeeded,
            getProductionProgress(a) + '%'
        ];
    });

    doc.autoTable({
        startY: 32,
        head: [['Line','PO No.','Description','Start','End','Working Days','Progress']],
        body: assignRows,
        theme: 'grid',
        headStyles: { fillColor: [30,30,30], textColor: [245,166,35], fontSize: 8, fontStyle: 'bold' },
        bodyStyles: { fontSize: 8, textColor: [40,40,40] },
        alternateRowStyles: { fillColor: [245,245,245] },
    });

    doc.save(`DAG_FactoryPlan_${today}.pdf`);
    showToast('PDF exported successfully', 'success');
}

// ============================================
// TOAST
// ============================================
let toastTimer;
function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast show ${type}`;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000);
}
// ============================================
// SEARCH / FILTER FUNCTIONS
// ============================================

function filterDashboard(query) {
    const q = query.toLowerCase();
    const cards = document.querySelectorAll("#dashboardLines .line-card");
    let visible = 0;
    cards.forEach(card => {
        const text = card.innerText.toLowerCase();
        const show = !q || text.includes(q);
        card.style.display = show ? "" : "none";
        if (show) visible++;
    });
    const el = document.getElementById("searchDashCount");
    if (el) el.textContent = q ? visible + " of " + cards.length + " lines" : "";
}

function filterLines(query) {
    const q = query.toLowerCase();
    const rows = document.querySelectorAll("#linesList tbody tr");
    let visible = 0;
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        const show = !q || text.includes(q);
        row.style.display = show ? "" : "none";
        if (show) visible++;
    });
    const el = document.getElementById("searchLinesCount");
    if (el) el.textContent = q ? visible + " of " + rows.length + " lines" : "";
}

function filterStyles(query) {
    const q = query.toLowerCase();
    const rows = document.querySelectorAll("#stylesList tbody tr");
    let visible = 0;
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        const show = !q || text.includes(q);
        row.style.display = show ? "" : "none";
        if (show) visible++;
    });
    const el = document.getElementById("searchStylesCount");
    if (el) el.textContent = q ? visible + " of " + rows.length + " POs" : "";
}

function filterAssignments(query) {
    const q = query.toLowerCase();
    const rows = document.querySelectorAll("#assignmentsList tbody tr");
    let visible = 0;
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        const show = !q || text.includes(q);
        row.style.display = show ? "" : "none";
        if (show) visible++;
    });
    const el = document.getElementById("searchAssignCount");
    if (el) el.textContent = q ? visible + " of " + rows.length + " assignments" : "";
}


// Click outside modal to close
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

// One-time assign page event listeners
document.getElementById('assignLine').addEventListener('change', function() {
    if (this.value) {
        const fd = getNextFeedingDate(this.value);
        document.getElementById('assignStartDate').value = fd;
    }
    updatePreview();
});
document.getElementById('assignStyle').addEventListener('change', updatePreview);
document.getElementById('assignStartDate').addEventListener('change', updatePreview);
</script>
</body>
</html>
